using Google.Protobuf;
@{
    // Utility functions for code generation
    string GetOpcodeParser(Google.Protobuf.Reflection.DescriptorProto proto)
    {
        System.Text.StringBuilder sb = new System.Text.StringBuilder();
        GetOpcodeParserSub(sb, proto);
        return sb.ToString();
    }
    void GetOpcodeParserSub(System.Text.StringBuilder sb, Google.Protobuf.Reflection.DescriptorProto proto)
    {	
        if(Model.TryGetOptionValue(proto, 54321, out int msgId))
        {
           sb.AppendLine($"                case {msgId}:");
           sb.AppendLine($"                    msg = new {proto.Name}();");
           sb.AppendLine("                    break;");
        }
        foreach(var i in proto.NestedTypes)
        {
           GetOpcodeParserSub(sb, i);
        }

    }
}
// <auto-generated>
//     Generated by the protocol buffer compiler.  DO NOT EDIT!
// </auto-generated>
@if(!string.IsNullOrEmpty(@Model.Files.DefaultPackage))
{
@:namespace @Model.Files.DefaultPackage
}
{	
    public sealed static class MessageParser
    {
        public static MessageBase ParseMessage(int opcode, System.IO.Stream stream)
        {
            MessageBase msg;
            switch
            {
                @foreach(var i in Model.Files.Files)
                {
                    @foreach(var type in i.MessageTypes)
                    {
                        string content = GetOpcodeParser(type);
                        @if(!string.IsNullOrEmpty(content))
                        {
@:@Raw(content)
                        }
                    }
                }
            }
            if(msg == null)
            {
                throw new System.Exception($"Unknown opcode:{opcode}");
            }
            CodedInputStream input = new CodedInputStream(stream);
            msg.MergeFrom(input);
            return msg;
        }
    }
}